@extends('layouts.admin')

@section('title', 'Manajemen Penugasan Pengawas')
@section('page-title', 'Manajemen Penugasan Pengawas')
@section('page-description', 'Kelola penugasan pengawas ujian berdasarkan jadwal dan sesi')

@section('content')
    <div class="space-y-6">
        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 mr-4">
                        <i class="fa-solid fa-calendar text-blue-500 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Sesi</p>
                        <p class="text-2xl font-semibold">{{ $stats['total_sesi'] }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 mr-4">
                        <i class="fa-solid fa-check-circle text-green-500 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600">Teralokasi</p>
                        <p class="text-2xl font-semibold">{{ $stats['assigned'] }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-amber-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-amber-100 mr-4">
                        <i class="fa-solid fa-exclamation-circle text-amber-500 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600">Belum Dialokasi</p>
                        <p class="text-2xl font-semibold">{{ $stats['unassigned'] }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 mr-4">
                        <i class="fa-solid fa-users text-purple-500 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-600">Jumlah Pengawas</p>
                        <p class="text-2xl font-semibold">{{ $stats['total_pengawas'] }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold mb-4">Filter Jadwal Ujian</h2>
            <form action="{{ route('koordinator.pengawas-assignment.index') }}" method="GET" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="tanggal" name="tanggal" value="{{ request('tanggal', $tanggal) }}"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                    </div>

                    <div>
                        <label for="jadwal_id" class="block text-sm font-medium text-gray-700 mb-1">Jadwal Ujian</label>
                        <select id="jadwal_id" name="jadwal_id"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                            <option value="">Pilih Jadwal Ujian</option>
                            @foreach ($jadwalUjians as $jadwal)
                                <option value="{{ $jadwal->id }}"
                                    {{ $selectedJadwal && $selectedJadwal->id == $jadwal->id ? 'selected' : '' }}>
                                    {{ $jadwal->judul }}
                                </option>
                            @endforeach
                        </select>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-150">
                        <i class="fa-solid fa-filter mr-2"></i> Filter
                    </button>
                </div>
            </form>
        </div>

        <!-- Session List -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Daftar Sesi Ruangan</h2>

                @if ($selectedJadwal && $sesiRuangans->count() > 0)
                    <div>
                        <button id="bulkAssignBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-150">
                            <i class="fa-solid fa-user-plus mr-2"></i> Tugaskan Pengawas
                        </button>
                    </div>
                @endif
            </div>

            @if ($selectedJadwal)
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800">{{ $selectedJadwal->judul }}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                        <div>
                            <span class="text-gray-600 text-sm">Tanggal:</span>
                            <span class="font-medium">{{ $selectedJadwal->tanggal->format('d M Y') }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">Mata Pelajaran:</span>
                            <span class="font-medium">{{ $selectedJadwal->mapel->nama_mapel ?? 'Unknown' }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">Durasi:</span>
                            <span class="font-medium">{{ $selectedJadwal->durasi_menit }} menit</span>
                        </div>
                    </div>
                </div>
            @endif

            @if ($selectedJadwal && $sesiRuangans->count() > 0)
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto max-h-[600px]">
                    @foreach ($sesiRuangans->groupBy(fn($s) => $s->ruangan->nama_ruangan ?? 'Unknown') as $ruanganNama => $sesiList)
                        <div class="bg-white shadow-md rounded-xl border">
                            {{-- Header Card --}}
                            <div class="bg-gray-100 flex items-center gap-3 py-3 px-4">
                                <input type="checkbox"
                                    class="select-all-ruangan rounded border-gray-300 text-blue-600 shadow-sm focus:ring focus:ring-blue-200"
                                    data-ruangan="{{ Str::slug($ruanganNama, '-') }}">
                                <h2 class="text-lg font-semibold text-gray-700">
                                    {{ $ruanganNama }}
                                </h2>

                            </div>

                            {{-- Daftar Sesi --}}
                            <div class="space-y-1">
                                @foreach ($sesiList as $sesi)
                                    <div class="p-4  hover:bg-gray-50 transition">
                                        <div class="flex items-center justify-between">
                                            {{-- Kiri: Info sesi --}}
                                            <div class="flex items-start space-x-3">
                                                <input type="checkbox" name="session_ids[]" value="{{ $sesi->id }}"
                                                    class="session-checkbox session-ruangan-{{ Str::slug($ruanganNama, '-') }} mt-1 rounded border-gray-300 text-blue-600 shadow-sm focus:ring focus:ring-blue-200">

                                                <div>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="font-semibold text-gray-900">
                                                            {{ $sesi->nama_sesi }}
                                                        </span>

                                                        @php
                                                            $statusColor = 'gray';
                                                            switch ($sesi->status) {
                                                                case 'belum_mulai':
                                                                    $statusColor = 'blue';
                                                                    $statusText = 'Belum Mulai';
                                                                    break;
                                                                case 'berlangsung':
                                                                    $statusColor = 'green';
                                                                    $statusText = 'Berlangsung';
                                                                    break;
                                                                case 'selesai':
                                                                    $statusColor = 'gray';
                                                                    $statusText = 'Selesai';
                                                                    break;
                                                                case 'dibatalkan':
                                                                    $statusColor = 'red';
                                                                    $statusText = 'Dibatalkan';
                                                                    break;
                                                                default:
                                                                    $statusText = 'Unknown';
                                                            }
                                                        @endphp

                                                        <span
                                                            class="px-2 py-0.5 text-xs font-semibold rounded-full bg-{{ $statusColor }}-100 text-{{ $statusColor }}-800">
                                                            {{ $statusText }}
                                                        </span>
                                                    </div>

                                                    <p class="text-sm text-gray-600 mt-0.5">
                                                        {{ substr($sesi->waktu_mulai, 0, 5) }} -
                                                        {{ substr($sesi->waktu_selesai, 0, 5) }}
                                                    </p>

                                                    {{-- Info Pengawas --}}
                                                    <div id="pengawas-display-{{ $sesi->id }}" class="mt-1">
                                                        @if ($sesi->pengawas_for_jadwal)
                                                            <p class="text-sm text-green-700 font-medium">
                                                                {{ $sesi->pengawas_for_jadwal->nama }}
                                                            </p>
                                                        @else
                                                            <p class="text-sm text-red-600 italic">Belum ditugaskan</p>
                                                        @endif
                                                    </div>
                                                </div>
                                            </div>

                                            {{-- Kanan: Tombol Aksi --}}
                                            <div class="flex flex-col space-y-2">
                                                <button type="button"
                                                    class="assign-pengawas px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                                                    data-sesi-id="{{ $sesi->id }}"
                                                    data-jadwal-id="{{ $selectedJadwal->id }}"
                                                    data-sesi-nama="{{ $sesi->nama_sesi }}"
                                                    data-ruangan="{{ $sesi->ruangan->nama_ruangan ?? 'Unknown' }}"
                                                    data-waktu="{{ substr($sesi->waktu_mulai, 0, 5) }} - {{ substr($sesi->waktu_selesai, 0, 5) }}">
                                                    <i class="fa-solid fa-user-plus"></i>
                                                </button>

                                                @if ($sesi->pengawas_for_jadwal)
                                                    <button type="button"
                                                        class="remove-pengawas px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
                                                        data-sesi-id="{{ $sesi->id }}"
                                                        data-jadwal-id="{{ $selectedJadwal->id }}">
                                                        <i class="fa-solid fa-user-minus"></i>
                                                    </button>
                                                @endif
                                            </div>
                                        </div>
                                    </div>
                                @endforeach
                            </div>

                        </div>
                    @endforeach
                </div>
            @elseif($selectedJadwal)
                <div class="bg-yellow-50 p-4 rounded-md">
                    <p class="text-yellow-800">Tidak ada sesi ruangan yang tersedia untuk jadwal ujian ini.</p>
                </div>
            @else
                <div class="bg-yellow-50 p-4 rounded-md">
                    <p class="text-yellow-800">Silakan pilih jadwal ujian untuk melihat daftar sesi ruangan.</p>
                </div>
            @endif

        </div>
    </div>

    <!-- Assign Modal -->
    <div id="assignModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-modal="true" role="dialog">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" id="modalBackdrop"></div>

            <div class="relative bg-white rounded-lg w-full max-w-lg mx-4 shadow-xl transform transition-all">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Tugaskan Pengawas</h3>
                    <p class="text-sm text-gray-500 mt-1" id="assignModalDetail"></p>
                </div>

                <div class="p-6">
                    <div class="mb-4">
                        <label for="pengawas_id" class="block text-sm font-medium text-gray-700 mb-2">Pilih
                            Pengawas</label>
                        <select id="pengawas_id"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                            <option value="">Pilih Pengawas</option>
                            @foreach ($availablePengawas as $pengawas)
                                <option value="{{ $pengawas->id }}">{{ $pengawas->nama }}
                                    ({{ $pengawas->nip ?? 'No NIP' }})
                                </option>
                            @endforeach
                        </select>
                    </div>

                    <div id="availabilityInfo" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-700 rounded-md">
                        <p><i class="fa-solid fa-exclamation-circle mr-2"></i> <span id="availabilityMessage"></span></p>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                    <button type="button" id="cancelAssign"
                        class="px-4 py-2 bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 mr-2">
                        Batal
                    </button>
                    <button type="button" id="confirmAssign"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Tugaskan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Assign Modal -->
    <div id="bulkAssignModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-modal="true" role="dialog">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" id="bulkModalBackdrop"></div>

            <div class="relative bg-white rounded-lg w-full max-w-lg mx-4 shadow-xl transform transition-all">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Tugaskan Pengawas ke Beberapa Sesi</h3>
                    <p class="text-sm text-gray-500 mt-1">Pilih pengawas untuk ditugaskan ke semua sesi yang dipilih</p>
                </div>

                <div class="p-6">
                    <div class="mb-4">
                        <p id="selectedSessionsCount" class="text-sm font-medium text-gray-700 mb-2">Tidak ada sesi yang
                            dipilih</p>
                    </div>

                    <div class="mb-4">
                        <label for="bulk_pengawas_id" class="block text-sm font-medium text-gray-700 mb-2">Pilih
                            Pengawas</label>
                        <select id="bulk_pengawas_id"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                            <option value="">Pilih Pengawas</option>
                            @foreach ($availablePengawas as $pengawas)
                                <option value="{{ $pengawas->id }}">{{ $pengawas->nama }}
                                    ({{ $pengawas->nip ?? 'No NIP' }})
                                </option>
                            @endforeach
                        </select>
                    </div>

                    <div id="bulkAvailabilityInfo" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-700 rounded-md">
                        <p><i class="fa-solid fa-exclamation-circle mr-2"></i> <span id="bulkAvailabilityMessage"></span>
                        </p>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                    <button type="button" id="cancelBulkAssign"
                        class="px-4 py-2 bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 mr-2">
                        Batal
                    </button>
                    <button type="button" id="confirmBulkAssign"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Tugaskan
                    </button>
                </div>
            </div>
        </div>
    </div>
@endsection



@section('scripts')
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedSesiId = null;
            let selectedJadwalId = null;

            // Single assign modal
            const assignModal = document.getElementById('assignModal');
            const modalBackdrop = document.getElementById('modalBackdrop');
            const cancelAssign = document.getElementById('cancelAssign');
            const confirmAssign = document.getElementById('confirmAssign');
            const assignModalDetail = document.getElementById('assignModalDetail');
            const availabilityInfo = document.getElementById('availabilityInfo');
            const availabilityMessage = document.getElementById('availabilityMessage');

            // Bulk assign modal
            const bulkAssignBtn = document.getElementById('bulkAssignBtn');
            const bulkAssignModal = document.getElementById('bulkAssignModal');
            const bulkModalBackdrop = document.getElementById('bulkModalBackdrop');
            const cancelBulkAssign = document.getElementById('cancelBulkAssign');
            const confirmBulkAssign = document.getElementById('confirmBulkAssign');
            const selectedSessionsCount = document.getElementById('selectedSessionsCount');
            const bulkAvailabilityInfo = document.getElementById('bulkAvailabilityInfo');
            const bulkAvailabilityMessage = document.getElementById('bulkAvailabilityMessage');

            // Select all checkbox
            const selectAll = document.getElementById('select-all');
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    document.querySelectorAll('.session-checkbox').forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateSelectedCount();
                });
            }

            // Select All per ruangan
            document.querySelectorAll('.select-all-ruangan').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const ruangan = this.dataset.ruangan;
                    document.querySelectorAll('.session-ruangan-' + ruangan).forEach(cb => {
                        cb.checked = this.checked;
                    });
                });
            });


            // Individual checkboxes
            document.querySelectorAll('.session-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });

            function updateSelectedCount() {
                const selectedCount = document.querySelectorAll('.session-checkbox:checked').length;
                if (selectedSessionsCount) {
                    if (selectedCount > 0) {
                        selectedSessionsCount.textContent = `${selectedCount} sesi dipilih`;
                    } else {
                        selectedSessionsCount.textContent = 'Tidak ada sesi yang dipilih';
                    }
                }
            }

            // Open bulk assign modal
            if (bulkAssignBtn) {
                bulkAssignBtn.addEventListener('click', function() {
                    const selectedCount = document.querySelectorAll('.session-checkbox:checked').length;

                    if (selectedCount === 0) {
                        alert('Silakan pilih minimal satu sesi terlebih dahulu.');
                        return;
                    }

                    updateSelectedCount();
                    bulkAssignModal.classList.remove('hidden');
                });
            }

            // Close bulk assign modal
            if (cancelBulkAssign) {
                cancelBulkAssign.addEventListener('click', function() {
                    bulkAssignModal.classList.add('hidden');
                });
            }

            if (bulkModalBackdrop) {
                bulkModalBackdrop.addEventListener('click', function() {
                    bulkAssignModal.classList.add('hidden');
                });
            }

            // Confirm bulk assign
            if (confirmBulkAssign) {
                confirmBulkAssign.addEventListener('click', function() {
                    const pengawasId = document.getElementById('bulk_pengawas_id').value;
                    const jadwalId = '{{ $selectedJadwal ? $selectedJadwal->id : '' }}';

                    if (!pengawasId) {
                        alert('Silakan pilih pengawas terlebih dahulu.');
                        return;
                    }

                    const selectedSessions = Array.from(document.querySelectorAll(
                        '.session-checkbox:checked')).map(checkbox => checkbox.value);

                    if (selectedSessions.length === 0) {
                        alert('Silakan pilih minimal satu sesi terlebih dahulu.');
                        return;
                    }

                    confirmBulkAssign.disabled = true;
                    confirmBulkAssign.innerHTML =
                        '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Memproses...';

                    fetch('{{ route('koordinator.pengawas-assignment.bulk-assign') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': '{{ csrf_token() }}'
                            },
                            body: JSON.stringify({
                                jadwal_ujian_id: jadwalId,
                                session_ids: selectedSessions,
                                pengawas_id: pengawasId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.message);
                                location.reload();
                            } else {
                                alert('Error: ' + data.message);
                                confirmBulkAssign.disabled = false;
                                confirmBulkAssign.innerHTML = 'Tugaskan';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Terjadi kesalahan saat memproses permintaan.');
                            confirmBulkAssign.disabled = false;
                            confirmBulkAssign.innerHTML = 'Tugaskan';
                        });
                });
            }

            // Assign pengawas button click
            document.querySelectorAll('.assign-pengawas').forEach(button => {
                button.addEventListener('click', function() {
                    selectedSesiId = this.dataset.sesiId;
                    selectedJadwalId = this.dataset.jadwalId;

                    const sesiNama = this.dataset.sesiNama;
                    const ruangan = this.dataset.ruangan;
                    const waktu = this.dataset.waktu;

                    assignModalDetail.textContent = `${sesiNama} | ${ruangan} | ${waktu}`;
                    assignModal.classList.remove('hidden');

                    // Check availability for this session
                    checkPengawasAvailability(selectedJadwalId, selectedSesiId);
                });
            });

            // Remove pengawas button click
            document.querySelectorAll('.remove-pengawas').forEach(button => {
                button.addEventListener('click', function() {
                    if (!confirm('Apakah Anda yakin ingin menghapus penugasan pengawas ini?')) {
                        return;
                    }

                    const sesiId = this.dataset.sesiId;
                    const jadwalId = this.dataset.jadwalId;

                    removePengawas(jadwalId, sesiId);
                });
            });

            // Close modal
            if (cancelAssign) {
                cancelAssign.addEventListener('click', function() {
                    assignModal.classList.add('hidden');
                });
            }

            if (modalBackdrop) {
                modalBackdrop.addEventListener('click', function() {
                    assignModal.classList.add('hidden');
                });
            }

            // Confirm assign
            if (confirmAssign) {
                confirmAssign.addEventListener('click', function() {
                    const pengawasId = document.getElementById('pengawas_id').value;

                    if (!pengawasId) {
                        alert('Silakan pilih pengawas terlebih dahulu.');
                        return;
                    }

                    confirmAssign.disabled = true;
                    confirmAssign.innerHTML =
                        '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Memproses...';

                    fetch('{{ route('koordinator.pengawas-assignment.assign') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': '{{ csrf_token() }}'
                            },
                            body: JSON.stringify({
                                jadwal_ujian_id: selectedJadwalId,
                                sesi_ruangan_id: selectedSesiId,
                                pengawas_id: pengawasId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const displayElement = document.getElementById(
                                    `pengawas-display-${selectedSesiId}`);
                                if (displayElement) {
                                    displayElement.innerHTML =
                                        `<div class="flex items-center"><span class="font-medium text-gray-900">${data.pengawas_name}</span></div>`;
                                }

                                // Add remove button if it doesn't exist
                                const actionCell = document.querySelector(
                                        `.assign-pengawas[data-sesi-id="${selectedSesiId}"]`)
                                    .parentElement;
                                if (!actionCell.querySelector('.remove-pengawas')) {
                                    const removeBtn = document.createElement('button');
                                    removeBtn.className =
                                        'remove-pengawas px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700';
                                    removeBtn.dataset.sesiId = selectedSesiId;
                                    removeBtn.dataset.jadwalId = selectedJadwalId;
                                    removeBtn.innerHTML = '<i class="fa-solid fa-user-minus"></i>';

                                    removeBtn.addEventListener('click', function() {
                                        if (!confirm(
                                                'Apakah Anda yakin ingin menghapus penugasan pengawas ini?'
                                            )) {
                                            return;
                                        }

                                        removePengawas(this.dataset.jadwalId, this.dataset
                                            .sesiId);
                                    });

                                    actionCell.appendChild(removeBtn);
                                }

                                assignModal.classList.add('hidden');
                            } else {
                                alert('Error: ' + data.message);
                            }

                            confirmAssign.disabled = false;
                            confirmAssign.innerHTML = 'Tugaskan';
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Terjadi kesalahan saat memproses permintaan.');
                            confirmAssign.disabled = false;
                            confirmAssign.innerHTML = 'Tugaskan';
                        });
                });
            }

            // Check pengawas availability
            function checkPengawasAvailability(jadwalId, sesiId) {
                fetch(
                        `{{ route('koordinator.pengawas-assignment.availability') }}?jadwal_ujian_id=${jadwalId}&sesi_ruangan_id=${sesiId}`
                    )
                    .then(response => response.json())
                    .then(data => {
                        if (data.unavailable && data.unavailable.length > 0) {
                            availabilityInfo.classList.remove('hidden');
                            availabilityMessage.textContent =
                                `${data.unavailable.length} pengawas tidak tersedia pada waktu ini karena konflik jadwal.`;
                        } else {
                            availabilityInfo.classList.add('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking availability:', error);
                    });
            }

            // Remove pengawas
            function removePengawas(jadwalId, sesiId) {
                fetch('{{ route('koordinator.pengawas-assignment.unassign') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({
                            jadwal_ujian_id: jadwalId,
                            sesi_ruangan_id: sesiId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const displayElement = document.getElementById(`pengawas-display-${sesiId}`);
                            if (displayElement) {
                                displayElement.innerHTML =
                                    '<span class="text-gray-500 italic">Belum ditugaskan</span>';
                            }

                            // Remove the remove button
                            const removeBtn = document.querySelector(
                                `.remove-pengawas[data-sesi-id="${sesiId}"]`);
                            if (removeBtn) {
                                removeBtn.remove();
                            }
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Terjadi kesalahan saat memproses permintaan.');
                    });
            }
        });
    </script>
@endsection
